@model AI_Task_Planner.Models.UserTask

@{
    ViewData["Title"] = "Task Details";
}

<div class="container mt-4">
    <div class="row">
        <div class="col-md-12">
            <div class="card shadow">
                <div class="card-header bg-primary text-white">
                    <div class="d-flex align-items-center">
                        <i class="fas fa-info-circle me-2 fa-lg"></i>
                        <h4 class="mb-0">Task Details</h4>
                    </div>
                </div>
                <div class="card-body">
                    <div class="row mb-4">
                        <div class="col-md-8">
                            <h3>@Model.Title</h3>
                            @if (Model.IsCompleted)
                            {
                                <span class="badge bg-success">Completed</span>
                            }
                            else
                            {
                                <span class="badge bg-warning">Pending</span>
                            }
                            @if (Model.Category != null)
                            {
                                <span class="badge bg-info ms-2">@Model.Category.Name</span>
                            }
                        </div>
                        <div class="col-md-4 text-end">
                            <span class="badge bg-@(Model.Priority == 1 ? "danger" : Model.Priority == 2 ? "warning" : "info")">
                                @(Model.Priority == 1 ? "High" : Model.Priority == 2 ? "Medium" : "Low") Priority
                            </span>
                        </div>
                    </div>

                    <div class="card mb-4">
                        <div class="card-header bg-light">
                            <h5 class="mb-0">Description</h5>
                        </div>
                        <div class="card-body">
                            @if (string.IsNullOrEmpty(Model.Description))
                            {
                                <em>No description available</em>
                            }
                            else
                            {
                                <p class="mb-0">@Model.Description</p>
                            }
                        </div>
                    </div>                    <div class="row mb-4">
                        <div class="col-md-6">
                            <div class="card mb-4">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0">Assignment</h5>
                                </div>
                                <div class="card-body">
                                    <dl class="row mb-0">
                                        @if (Model.AssignedToUser != null)
                                        {
                                            <dt class="col-sm-4">Assigned To</dt>
                                            <dd class="col-sm-8">
                                                <span class="badge bg-info">
                                                    <i class="fas fa-user me-1"></i> @Model.AssignedToUser.FirstName @Model.AssignedToUser.LastName
                                                </span>
                                            </dd>
                                        }
                                        
                                        @if (Model.AssignedByUser != null)
                                        {
                                            <dt class="col-sm-4">Assigned By</dt>
                                            <dd class="col-sm-8">@Model.AssignedByUser.FirstName @Model.AssignedByUser.LastName</dd>
                                        }
                                        
                                        @if (Model.AssignedOn.HasValue)
                                        {
                                            <dt class="col-sm-4">Assigned On</dt>
                                            <dd class="col-sm-8">@Model.AssignedOn.Value.ToString("MMM d, yyyy h:mm tt")</dd>
                                        }
                                    </dl>
                                </div>
                            </div>
                            
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0">Timeline</h5>
                                </div>
                                <div class="card-body">
                                    <dl class="row mb-0">
                                        <dt class="col-sm-4">Created On</dt>
                                        <dd class="col-sm-8">@Model.CreatedOn.ToString("MMM d, yyyy h:mm tt")</dd>

                                        @if (Model.ModifiedOn.HasValue)
                                        {
                                            <dt class="col-sm-4">Last Modified</dt>
                                            <dd class="col-sm-8">@Model.ModifiedOn.Value.ToString("MMM d, yyyy h:mm tt")</dd>
                                        }

                                        @if (Model.DueDate.HasValue)
                                        {
                                            <dt class="col-sm-4">Due Date</dt>
                                            <dd class="col-sm-8">
                                                @Model.DueDate.Value.ToString("MMM d, yyyy")
                                                @if (Model.DueDate.Value.Date == DateTime.Today)
                                                {
                                                    <span class="badge bg-warning ms-2">Today</span>
                                                }
                                                else if (Model.DueDate.Value.Date < DateTime.Today && !Model.IsCompleted)
                                                {
                                                    <span class="badge bg-danger ms-2">Overdue</span>
                                                }
                                            </dd>
                                        }
                                    </dl>
                                </div>
                            </div>
                        </div>
                        <div class="col-md-6">
                            <div class="card">
                                <div class="card-header bg-light">
                                    <h5 class="mb-0">Actions</h5>
                                </div>
                                <div class="card-body">
                                    <form asp-action="ToggleComplete" asp-route-id="@Model.TaskId" method="post" class="mb-2">
                                        <button type="submit" class="btn btn-@(Model.IsCompleted ? "warning" : "success") w-100">
                                            <i class="fas @(Model.IsCompleted ? "fa-times-circle" : "fa-check-circle") me-2"></i>
                                            @(Model.IsCompleted ? "Mark as Incomplete" : "Mark as Complete")
                                        </button>
                                    </form>

                                    <div class="d-flex mt-3">
                                        <a asp-action="Edit" asp-route-id="@Model.TaskId" class="btn btn-primary flex-grow-1 me-2">
                                            <i class="fas fa-edit me-2"></i>Edit
                                        </a>
                                        
                                        @if (ViewBag.UserRole == "Manager" || ViewBag.UserRole == "Lead")
                                        {
                                            <a asp-action="Delete" asp-route-id="@Model.TaskId" class="btn btn-danger flex-grow-1">
                                                <i class="fas fa-trash-alt me-2"></i>Delete
                                            </a>
                                        }
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>                    <!-- Time Tracking Section -->
                    <div class="card mb-4">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">
                                <i class="fas fa-clock me-2"></i>Time Tracking
                            </h5>
                            <div>                                @if (ViewBag.HasActiveTimer == true)
                                {
                                    <div class="btn-group">
                                        <a asp-controller="TimeLogs" asp-action="StopTimer" asp-route-taskId="@Model.TaskId" class="btn btn-danger">
                                            <i class="fas fa-stop-circle me-1"></i>Stop
                                        </a>
                                        @if (ViewBag.IsTimerPaused == true)
                                        {
                                            <a asp-controller="TimeLogs" asp-action="ResumeTimer" asp-route-taskId="@Model.TaskId" class="btn btn-info">
                                                <i class="fas fa-play-circle me-1"></i>Resume
                                            </a>
                                        }
                                        else
                                        {
                                            <a asp-controller="TimeLogs" asp-action="PauseTimer" asp-route-taskId="@Model.TaskId" class="btn btn-warning">
                                                <i class="fas fa-pause-circle me-1"></i>Pause
                                            </a>
                                        }
                                    </div>
                                }
                                else
                                {
                                    <a asp-controller="TimeLogs" asp-action="StartTimer" asp-route-taskId="@Model.TaskId" class="btn btn-success">
                                        <i class="fas fa-play-circle me-1"></i>Start Timer
                                    </a>
                                }
                                <a asp-controller="TimeLogs" asp-action="ForTask" asp-route-id="@Model.TaskId" class="btn btn-primary ms-2">
                                    <i class="fas fa-list me-1"></i>View All Time Logs
                                </a>
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="row">
                                <div class="col-md-4">
                                    <div class="text-center p-3 border rounded bg-light">
                                        <h3 class="mb-0">
                                            @if (Model.TotalTimeSpent < 60)
                                            {
                                                <span>@Model.TotalTimeSpent min</span>
                                            }
                                            else
                                            {
                                                <span>@(Model.TotalTimeSpent / 60)h @(Model.TotalTimeSpent % 60)m</span>
                                            }
                                        </h3>
                                        <p class="text-muted mb-0">Total Time Spent</p>
                                    </div>
                                </div>
                                <div class="col-md-8">
                                    @if (ViewBag.HasActiveTimer == true)
                                    {
                                        <div class="alert alert-info">
                                            <i class="fas fa-spinner fa-spin me-2"></i>
                                            <strong>Timer running!</strong> You currently have an active timer for this task.
                                        </div>
                                    }
                                    
                                    @if (Model.TimeLogs != null && Model.TimeLogs.Any())
                                    {
                                        <h6 class="mb-3">Recent Activity</h6>
                                        @foreach (var log in Model.TimeLogs.OrderByDescending(l => l.StartTime).Take(3))
                                        {
                                            <div class="d-flex align-items-center mb-2 p-2 border-bottom">
                                                <div>
                                                    <i class="fas fa-user-circle fa-2x text-muted me-2"></i>
                                                </div>
                                                <div class="flex-grow-1">
                                                    <div><strong>@log.User.UserName</strong></div>
                                                    <div class="text-muted">@log.StartTime.ToString("MMM d, h:mm tt")</div>
                                                </div>
                                                <div class="text-end">
                                                    @if (log.EndTime.HasValue)
                                                    {
                                                        <span class="badge bg-success">
                                                            @log.DurationMinutes min
                                                        </span>
                                                    }
                                                    else
                                                    {
                                                        <span class="badge bg-warning text-dark">Active</span>
                                                    }
                                                </div>
                                            </div>
                                        }
                                    }
                                </div>
                            </div>
                        </div>
                    </div>                    <div class="card mb-4">
                        <div class="card-header bg-light d-flex justify-content-between align-items-center">
                            <h5 class="mb-0">Time Tracking</h5>                            <div>
                                @if (ViewBag.HasActiveTimer == true)
                                {
                                    <a asp-controller="TaskTime" asp-action="PauseTimer" asp-route-taskId="@Model.TaskId" asp-route-returnUrl="@Context.Request.Path" class="btn btn-warning btn-sm me-2">
                                        <i class="fas fa-pause me-1"></i>Pause
                                    </a>
                                    <a asp-controller="TaskTime" asp-action="StopTimer" asp-route-taskId="@Model.TaskId" asp-route-returnUrl="@Context.Request.Path" class="btn btn-danger btn-sm">
                                        <i class="fas fa-stop me-1"></i>Stop
                                    </a>
                                }
                                else if (ViewBag.HasPausedTimer == true)
                                {
                                    <a asp-controller="TaskTime" asp-action="ResumeTimer" asp-route-taskId="@Model.TaskId" asp-route-returnUrl="@Context.Request.Path" class="btn btn-info btn-sm me-2">
                                        <i class="fas fa-play me-1"></i>Resume
                                    </a>
                                    <a asp-controller="TaskTime" asp-action="StartTimer" asp-route-taskId="@Model.TaskId" asp-route-returnUrl="@Context.Request.Path" class="btn btn-success btn-sm">
                                        <i class="fas fa-redo me-1"></i>New Timer
                                    </a>
                                }
                                else
                                {
                                    <a asp-controller="TaskTime" asp-action="StartTimer" asp-route-taskId="@Model.TaskId" asp-route-returnUrl="@Context.Request.Path" class="btn btn-success btn-sm">
                                        <i class="fas fa-play me-1"></i>Start Timer
                                    </a>
                                }
                            </div>
                        </div>
                        <div class="card-body">
                            <div class="d-flex justify-content-between align-items-center mb-3">
                                <h6 class="mb-0">Time Log History</h6>
                                <a asp-controller="TimeLogs" asp-action="ForTask" asp-route-id="@Model.TaskId" class="btn btn-outline-primary btn-sm">
                                    <i class="fas fa-clock me-1"></i>View All Time Logs
                                </a>
                            </div>
                            
                            @if (Model.TimeLogs != null && Model.TimeLogs.Any())
                            {
                                <div class="table-responsive">
                                    <table class="table table-sm table-hover">
                                        <thead>
                                            <tr>
                                                <th>User</th>
                                                <th>Start</th>
                                                <th>End</th>
                                                <th>Duration</th>
                                                <th>Description</th>
                                            </tr>
                                        </thead>
                                        <tbody>
                                            @foreach (var log in Model.TimeLogs.OrderByDescending(l => l.StartTime).Take(5))
                                            {
                                                <tr>
                                                    <td>@log.User.UserName</td>
                                                    <td>@log.StartTime.ToString("MMM d, h:mm tt")</td>
                                                    <td>@(log.EndTime.HasValue ? log.EndTime.Value.ToString("h:mm tt") : "-")</td>
                                                    <td>@(log.EndTime.HasValue ? $"{log.DurationMinutes} min" : "Running")</td>
                                                    <td>@(string.IsNullOrEmpty(log.Description) ? "-" : log.Description)</td>
                                                </tr>
                                            }
                                        </tbody>
                                    </table>
                                </div>
                            }
                            else
                            {
                                <p class="text-muted text-center">No time logs recorded for this task yet.</p>
                            }
                        </div>
                    </div>

                    <div class="form-group d-flex justify-content-between pt-3 border-top">
                        <a asp-action="Index" class="btn btn-outline-secondary">
                            <i class="fas fa-arrow-left me-2"></i>Back to List
                        </a>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>
