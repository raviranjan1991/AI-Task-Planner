@{
    ViewData["Title"] = "Home";
    var isManager = ViewBag.UserRole == "Manager";
}

@if (User.Identity != null && User.Identity.IsAuthenticated)
{
    <div class="card mb-5 shadow-sm">
        <div class="card-body">
            <div class="row align-items-center">
                <div class="col-md-2 text-center">
                    <i class="fas fa-user-circle text-primary" style="font-size: 5rem;"></i>
                </div>
                <div class="col-md-10">
                    <h2 class="mb-2">Welcome back, @User.Identity.Name!</h2>
                    <p class="lead mb-0">Here's your task management dashboard. Get organized and boost your productivity today.</p>
                </div>
            </div>
        </div>
    </div>
}
else
{
    <div class="text-center mb-5">
        <h1 class="display-4">Welcome to AI Task Planner</h1>
        <p class="lead">Your intelligent task management system</p>
    </div>
}

@if (User.Identity != null && User.Identity.IsAuthenticated)
{
    <div class="alert alert-info mb-4" role="alert">
        <div class="d-flex align-items-center">
            <div class="me-3">
                <i class="fas fa-magic fa-2x"></i>
            </div>
            <div>
                <h4 class="alert-heading mb-1">New Feature: Natural Language Task Creation!</h4>
                <p class="mb-0">Try our new way to create tasks using natural language descriptions. Simply type in what you need, and we'll handle the details.</p>
            </div>
            <div class="ms-auto">
                <a asp-controller="Tasks" asp-action="CreateWithNL" class="btn btn-primary">Try it now</a>
            </div>
        </div>
    </div>
}

<div class="row mb-4">
    <div class="col-md-3 mb-3">
        <div class="card bg-primary text-white h-100">
            <div class="card-body py-5">
                <h2 class="card-title text-center">@ViewBag.TotalTasks</h2>
                <p class="card-text text-center mb-0">Total Tasks</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card bg-success text-white h-100">
            <div class="card-body py-5">
                <h2 class="card-title text-center">@ViewBag.CompletedTasks</h2>
                <p class="card-text text-center mb-0">Completed Tasks</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card bg-warning text-dark h-100">
            <div class="card-body py-5">
                <h2 class="card-title text-center">@ViewBag.DueTodayCount</h2>
                <p class="card-text text-center mb-0">Due Today</p>
            </div>
        </div>
    </div>
    <div class="col-md-3 mb-3">
        <div class="card bg-danger text-white h-100">
            <div class="card-body py-5">
                <h2 class="card-title text-center">@ViewBag.OverdueCount</h2>
                <p class="card-text text-center mb-0">Overdue</p>
            </div>
        </div>
    </div>
</div>

<div class="row">
    <div class="col-md-12">
        <div class="card">            <div class="card-header d-flex justify-content-between align-items-center">
                <h5 class="mb-0">@(ViewBag.UserRole == "Manager" ? "Tasks Overview" : "Upcoming Tasks")</h5>
                <a class="btn btn-primary btn-sm" asp-controller="Tasks" asp-action="Create">Add New Task</a>
            </div>
            <div class="card-body">
                @if (ViewBag.UpcomingTasks != null && ViewBag.UpcomingTasks.Count > 0)
                {
                    <div class="table-responsive">
                        <table class="table table-hover">                            <thead>                                <tr>
                                    <th>Task</th>
                                    <th>Category</th>
                                    <th>@(ViewBag.UserRole != "User" ? "Assigned To" : "")</th>
                                    <th>Due Date</th>
                                    <th>Priority</th>
                                    <th>Status</th>
                                    <th>Actions</th>
                                </tr>
                            </thead>
                            <tbody>                                @foreach (var task in ViewBag.UpcomingTasks)
                                {                                    <tr class="@(task.IsCompleted ? "table-success" : (task.DueDate != null && ((DateTime)task.DueDate).Date < DateTime.Today ? "table-danger" : ""))">
                                        <td>@task.Title</td>
                                        <td>@(task.Category?.Name ?? "None")</td>
                                        @if (ViewBag.UserRole != "User")
                                        {
                                            <td>
                                                @if (task.AssignedToUser != null)
                                                {
                                                    <span>@task.AssignedToUser.FirstName @task.AssignedToUser.LastName</span>
                                                }
                                                else
                                                {
                                                    <span class="text-muted">Unassigned</span>
                                                }
                                            </td>
                                        }
                                        <td>                                            @if (task.DueDate != null)
                                            {
                                                @Convert.ToDateTime(task.DueDate).ToShortDateString()
                                                
                                                @if (Convert.ToDateTime(task.DueDate).Date == DateTime.Today)
                                                {
                                                    <span class="badge bg-warning text-dark">Today</span>
                                                }
                                                else if (Convert.ToDateTime(task.DueDate).Date < DateTime.Today)
                                                {
                                                    <span class="badge bg-danger">Overdue</span>
                                                }
                                            }
                                            else
                                            {
                                                <span>No due date</span>
                                            }
                                        </td>
                                        <td>
                                            @{
                                                var priorityText = task.Priority switch
                                                {
                                                    1 => "High",
                                                    2 => "Medium",
                                                    3 => "Low",
                                                    _ => "None"
                                                };
                                                
                                                var priorityBadge = task.Priority switch
                                                {
                                                    1 => "bg-danger",
                                                    2 => "bg-warning text-dark",
                                                    3 => "bg-info text-dark",
                                                    _ => "bg-secondary"
                                                };
                                            }
                                            <span class="badge @priorityBadge">@priorityText</span>
                                        </td>                                        <td>
                                            @if (task.IsCompleted)
                                            {
                                                <span class="badge bg-success">Completed</span>
                                            }
                                            else if (task.DueDate != null && Convert.ToDateTime(task.DueDate).Date < DateTime.Today)
                                            {
                                                <span class="badge bg-danger">Overdue</span>
                                            }
                                            else if (task.DueDate != null && Convert.ToDateTime(task.DueDate).Date == DateTime.Today)
                                            {
                                                <span class="badge bg-warning text-dark">Due Today</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-info text-dark">In Progress</span>
                                            }
                                        </td>
                                        <td>
                                            <a asp-controller="Tasks" asp-action="Edit" asp-route-id="@task.TaskId" class="btn btn-sm btn-outline-primary">Edit</a>
                                            <a asp-controller="Tasks" asp-action="Details" asp-route-id="@task.TaskId" class="btn btn-sm btn-outline-info">Details</a>
                                        </td>
                                    </tr>
                                }
                            </tbody>
                        </table>
                    </div>
                }
                else
                {
                    <div class="text-center py-4">
                        <p class="mb-0">No upcoming tasks. Create some tasks to get started.</p>
                        <a class="btn btn-primary mt-3" asp-controller="Tasks" asp-action="Create">Create Task</a>
                    </div>
                }
            </div>
        </div>
    </div>
</div>

<div class="row mt-4">
    <div class="col-md-12 text-center">
        <a class="btn btn-outline-primary" asp-controller="Tasks" asp-action="Index">View All Tasks</a>
        <a class="btn btn-outline-secondary" asp-controller="TaskCategories" asp-action="Index">Manage Categories</a>
    </div>
</div>
